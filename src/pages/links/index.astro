---
/**
 * Links Index Page
 * Display all friendly links
 * 
 * Features:
 * - Group display by type (friends, sites, social)
 * - Card display with background preview
 * - Semi-transparent mask, disappears on hover
 * - Category filtering
 * - Responsive layout
 */
import LinksLayout from '../../layouts/links/LinksLayout.astro';
import LinksHeader from '../../components/links/LinksHeader.astro';
import LinksCategoryTabs from '../../components/links/LinksCategoryTabs.astro';
import LinkCard from '../../components/links/LinkCard.astro';
import { friendLinks, linkCategories, linkApplicationInfo, mySiteInfo } from '../../data/links.config';
import { useI18n } from '../../utils/i18n';

const { t } = useI18n();

// Group by type
const friendsLinks = friendLinks.filter(link => link.type === 'friend');
const sitesLinks = friendLinks.filter(link => link.type === 'site');
const socialLinks = friendLinks.filter(link => link.type === 'social');

// Calculate statistics
const totalLinks = friendLinks.length;
const featuredLinks = friendLinks.filter(link => link.featured).length;
const friendsCount = friendsLinks.length;
const sitesCount = sitesLinks.length;
const socialCount = socialLinks.length;

// Calculate link count for each type category
function getLinkCounts(links: typeof friendLinks, categories: typeof linkCategories.friend) {
  const counts: Record<string, number> = {};
  categories.forEach(category => {
    if (category.id === 'all') {
      counts[category.id] = links.length;
    } else if (category.id === 'featured') {
      counts[category.id] = links.filter(l => l.featured).length;
    } else {
      counts[category.id] = links.filter(l => l.category === category.id).length;
    }
  });
  return counts;
}

const friendLinkCounts = getLinkCounts(friendsLinks, linkCategories.friend);
const siteLinkCounts = getLinkCounts(sitesLinks, linkCategories.site);
const socialLinkCounts = getLinkCounts(socialLinks, linkCategories.social);

console.log(`ðŸ“Š Loaded ${totalLinks} links: ${friendsLinks.length} friends, ${sitesLinks.length} sites, ${socialLinks.length} social`);
---

<LinksLayout>
  <!-- Page title and statistics -->
  <LinksHeader 
    totalLinks={totalLinks}
    featuredLinks={featuredLinks}
    friendsCount={friendsCount}
    sitesCount={sitesCount}
    socialCount={socialCount}
  />

  <!-- Friend links -->
  {friendsLinks.length > 0 && (
    <section class="links-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="i-carbon:user-favorite"></i>
          <span data-i18n="links.friendLinks">{t('links.friendLinks')}</span>
        </h2>
        <p class="section-desc" data-i18n="links.friendLinks.desc">{t('links.friendLinks.desc')}</p>
      </div>

      <LinksCategoryTabs 
        categories={linkCategories.friend}
        linkCounts={friendLinkCounts}
        currentCategory="all"
        groupId="friend"
      />

      <div class="links-grid" data-group="friend">
        {friendsLinks.map((link) => (
          <LinkCard link={link} />
        ))}
      </div>
    </section>
  )}

  <!-- Site sharing -->
  {sitesLinks.length > 0 && (
    <section class="links-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="i-carbon:earth"></i>
          <span data-i18n="links.websites">{t('links.websites')}</span>
        </h2>
        <p class="section-desc" data-i18n="links.websites.desc">{t('links.websites.desc')}</p>
      </div>

      <LinksCategoryTabs 
        categories={linkCategories.site}
        linkCounts={siteLinkCounts}
        currentCategory="all"
        groupId="site"
      />

      <div class="links-grid" data-group="site">
        {sitesLinks.map((link) => (
          <LinkCard link={link} />
        ))}
      </div>
    </section>
  )}

  <!-- Personal social -->
  {socialLinks.length > 0 && (
    <section class="links-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="i-carbon:share"></i>
          <span data-i18n="links.social">{t('links.social')}</span>
        </h2>
        <p class="section-desc" data-i18n="links.social.desc">{t('links.social.desc')}</p>
      </div>

      <LinksCategoryTabs 
        categories={linkCategories.social}
        linkCounts={socialLinkCounts}
        currentCategory="all"
        groupId="social"
      />

      <div class="links-grid" data-group="social">
        {socialLinks.map((link) => (
          <LinkCard link={link} />
        ))}
      </div>
    </section>
  )}

  <!-- Apply for link exchange -->
  <div class="apply-section">
    <h2 class="apply-section-title">
      <i class="i-carbon:user-follow"></i>
      <span data-i18n="links.apply.title">{linkApplicationInfo.title}</span>
    </h2>
    
    <div class="apply-grid">
      <!-- Left: Application instructions -->
      <div class="apply-card">
        <div class="apply-card-header">
          <i class="i-carbon:document"></i>
          <h3 data-i18n="links.apply.requirements">Application Instructions</h3>
        </div>
        <div class="apply-card-content">
          <div class="requirements-list">
            <div class="requirement-item">
              <i class="i-carbon:checkmark-filled requirement-icon"></i>
              <div class="requirement-text">
                <strong>Healthy Content</strong>
                <p>No illegal, violent, pornographic or inappropriate content</p>
              </div>
            </div>
            <div class="requirement-item">
              <i class="i-carbon:checkmark-filled requirement-icon"></i>
              <div class="requirement-text">
                <strong>Accessible</strong>
                <p>Website is stable and loads at reasonable speed</p>
              </div>
            </div>
            <div class="requirement-item">
              <i class="i-carbon:checkmark-filled requirement-icon"></i>
              <div class="requirement-text">
                <strong>Mutual Exchange</strong>
                <p>Please add this site's link on your website first</p>
              </div>
            </div>
            <div class="requirement-item">
              <i class="i-carbon:checkmark-filled requirement-icon"></i>
              <div class="requirement-text">
                <strong>Regular Updates</strong>
                <p>Website maintains reasonable update frequency</p>
              </div>
            </div>
          </div>
          <div class="contact-section">
            <p class="contact-hint">After meeting the above requirements, please contact me via:</p>
            <div class="contact-buttons">
              {linkApplicationInfo.contacts.map((contact) => (
                <button class="contact-button" data-contact={contact.value}>
                  <i class={contact.icon}></i>
                  <span>{contact.label}</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Site information -->
      <div class="apply-card site-info-card">
        <div class="apply-card-header">
          <i class="i-carbon:information"></i>
          <h3 data-i18n="links.apply.siteInfo">Site Information</h3>
        </div>
        <div class="apply-card-content">
          <div class="site-info">
            <div class="site-avatar-wrapper">
              <img src={mySiteInfo.avatar} alt={mySiteInfo.name} class="site-avatar" />
            </div>
            <div class="site-details">
              <div class="info-row" data-copy={mySiteInfo.name}>
                <div class="info-content">
                  <span class="info-label" data-i18n="links.apply.siteName">Site Name</span>
                  <span class="info-value">{mySiteInfo.name}</span>
                </div>
                <button class="copy-btn" title="Copy">
                  <i class="i-carbon:copy"></i>
                </button>
              </div>
              <div class="info-row" data-copy={mySiteInfo.url}>
                <div class="info-content">
                  <span class="info-label" data-i18n="links.apply.siteUrl">Site URL</span>
                  <span class="info-value">{mySiteInfo.url}</span>
                </div>
                <button class="copy-btn" title="Copy">
                  <i class="i-carbon:copy"></i>
                </button>
              </div>
              <div class="info-row" data-copy={mySiteInfo.description}>
                <div class="info-content">
                  <span class="info-label" data-i18n="links.apply.siteDesc">Site Description</span>
                  <span class="info-value">{mySiteInfo.description}</span>
                </div>
                <button class="copy-btn" title="Copy">
                  <i class="i-carbon:copy"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</LinksLayout>

<script>
  import { initLinksAnimation } from '../../scripts/animations/links-animation';
  import { initI18n } from '../../scripts/i18n-content-updater';

  // Initialize i18n
  initI18n();
  
  // Initialize animation effects
  initLinksAnimation();

  // Initialize animation effects
  initLinksAnimation();

  // Category filtering functionality (with group support)
  document.addEventListener('DOMContentLoaded', () => {
    const categoryTabs = document.querySelectorAll('.category-tab');

    categoryTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const category = tab.getAttribute('data-category');
        const groupId = tab.getAttribute('data-group');

        if (!category || !groupId) return;

        // Get all tabs and cards in current group
        const groupTabs = document.querySelectorAll(`.category-tab[data-group="${groupId}"]`);
        const groupGrid = document.querySelector(`.links-grid[data-group="${groupId}"]`);
        
        if (!groupGrid) return;
        
        const linkCards = groupGrid.querySelectorAll('.link-card');

        // Update active state (current group only)
        requestAnimationFrame(() => {
          groupTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Filter cards (with animation effects)
          let visibleIndex = 0;
          linkCards.forEach((card) => {
            const cardCategory = card.getAttribute('data-category');
            const isFeatured = card.getAttribute('data-featured') === 'true';
            
            let shouldShow = false;
            if (category === 'all') {
              shouldShow = true;
            } else if (category === 'featured') {
              shouldShow = isFeatured;
            } else {
              shouldShow = cardCategory === category;
            }

            if (shouldShow) {
              // Show card with delayed animation
              card.classList.remove('hidden');
              setTimeout(() => {
                card.classList.add('animate-in');
              }, visibleIndex * 50);
              visibleIndex++;
            } else {
              // Hide card
              card.classList.add('hidden');
              card.classList.remove('animate-in');
            }
          });
        });
      });
    });

    // Copy functionality
    const copyButtons = document.querySelectorAll('.copy-btn');
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const row = btn.closest('.info-row');
        const textToCopy = row?.getAttribute('data-copy');
        
        if (!textToCopy) return;

        try {
          await navigator.clipboard.writeText(textToCopy);
          
          // Show copy success state
          btn.classList.add('copied');
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = 'i-carbon:checkmark-filled';
          }
          
          // Reset after 2 seconds
          setTimeout(() => {
            btn.classList.remove('copied');
            if (icon) {
              icon.className = 'i-carbon:copy';
            }
          }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
        }
      });
    });
  });
</script>

<style>
  /* Group sections */
  .links-section {
    margin-bottom: 3rem;
  }

  .section-header {
    margin-bottom: 1.25rem;
    text-align: center;
  }

  .section-title {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--md-sys-color-on-surface);
    margin: 0 0 0.375rem 0;
  }

  .section-title i {
    font-size: 1.25rem;
    color: var(--md-sys-color-primary);
  }

  .section-desc {
    font-size: 0.8125rem;
    color: var(--md-sys-color-on-surface-variant);
    margin: 0;
  }

  /* Links grid */
  .links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.875rem;
    margin-top: 1.25rem;
  }

  /* Apply for link exchange section */
  .apply-section {
    margin-top: 4rem;
    padding-top: 2.5rem;
    border-top: 2px dashed var(--md-sys-color-outline-variant);
  }

  .apply-section-title {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--md-sys-color-on-surface);
    margin: 0 auto 1.5rem;
  }

  .apply-section-title i {
    font-size: 1.25rem;
    color: var(--md-sys-color-primary);
  }

  .apply-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }

  .apply-card {
    background: var(--md-sys-color-surface);
    border: 2px solid var(--md-sys-color-outline-variant);
    border-radius: 14px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 340px;
  }

  .apply-card-header {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 1.125rem 1.25rem;
    background: linear-gradient(
      135deg,
      var(--md-sys-color-primary-container) 0%,
      var(--md-sys-color-secondary-container) 100%
    );
    border-bottom: 2px solid var(--md-sys-color-outline-variant);
  }

  .apply-card-header i {
    font-size: 1.25rem;
    color: var(--md-sys-color-on-primary-container);
  }

  .apply-card-header h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--md-sys-color-on-primary-container);
    margin: 0;
  }

  .apply-card-content {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .apply-description {
    font-size: 0.9375rem;
    color: var(--md-sys-color-on-surface-variant);
    line-height: 1.8;
    margin: 0 0 1.5rem 0;
    white-space: pre-line;
    flex: 1;
  }

  /* Application requirements list */
  .requirements-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.125rem;
  }

  .requirement-item {
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    padding: 0.625rem 0.875rem;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    border: 1px solid var(--md-sys-color-outline-variant);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .requirement-item:hover {
    background: rgba(255, 255, 255, 0.8);
    border-color: var(--md-sys-color-primary);
    transform: translateX(4px);
  }

  .requirement-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: var(--md-sys-color-primary);
    background: var(--md-sys-color-primary-container);
    border-radius: 50%;
    padding: 0.25rem;
  }

  .requirement-text {
    flex: 1;
  }

  .requirement-text strong {
    display: block;
    font-size: 0.8125rem;
    font-weight: 700;
    color: var(--md-sys-color-on-surface);
    margin-bottom: 0.125rem;
  }

  .requirement-text p {
    font-size: 0.75rem;
    color: var(--md-sys-color-on-surface-variant);
    margin: 0;
    line-height: 1.4;
  }

  /* Contact section */
  .contact-section {
    margin-top: auto;
  }

  .contact-hint {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--md-sys-color-on-surface);
    margin: 0 0 0.75rem 0;
  }

  .contact-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
    margin-top: auto;
  }

  .contact-button {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    background: var(--md-sys-color-secondary-container);
    color: var(--md-sys-color-on-secondary-container);
    border: none;
    border-radius: 20px;
    font-size: 0.8125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
  }

  .contact-button:hover {
    background: var(--md-sys-color-secondary);
    color: var(--md-sys-color-on-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  }

  .contact-button:active {
    transform: translateY(0);
  }

  .contact-button i {
    font-size: 0.9375rem;
  }

  /* Site info card */
  .site-info-card {
    background: linear-gradient(
      135deg,
      var(--md-sys-color-tertiary-container) 0%,
      var(--md-sys-color-primary-container) 100%
    );
    border-color: var(--md-sys-color-tertiary);
  }

  .site-info-card .apply-card-header {
    background: linear-gradient(
      135deg,
      var(--md-sys-color-tertiary-container) 0%,
      var(--md-sys-color-secondary-container) 100%
    );
  }

  .site-info-card .apply-card-header i {
    color: var(--md-sys-color-on-tertiary-container);
  }

  .site-info-card .apply-card-header h3 {
    color: var(--md-sys-color-on-tertiary-container);
  }

  .site-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    flex: 1;
  }

  .site-avatar-wrapper {
    display: flex;
    justify-content: center;
    padding: 0.75rem 0;
  }

  .site-avatar {
    width: 72px;
    height: 72px;
    border-radius: 18px;
    object-fit: cover;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    border: 2px solid var(--md-sys-color-surface);
  }

  .site-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    flex: 1;
  }

  .info-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.625rem;
    padding: 0.75rem 0.875rem;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    backdrop-filter: blur(8px);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .info-row:hover {
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .info-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    min-width: 0;
  }

  .info-label {
    font-size: 0.6875rem;
    font-weight: 700;
    color: var(--md-sys-color-on-tertiary-container);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
  }

  .info-value {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--md-sys-color-on-surface);
    word-break: break-word;
  }

  /* Copy button */
  .copy-btn {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 1rem;
  }

  .copy-btn:hover {
    background: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
    transform: scale(1.1);
  }

  .copy-btn:active {
    transform: scale(0.95);
  }

  .copy-btn.copied {
    background: var(--md-ref-palette-success);
    color: white;
  }

  .copy-btn.copied i::before {
    content: '\f188'; /* checkmark icon code */
  }

  /* Responsive design */
  @media (max-width: 968px) {
    .links-grid {
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    .apply-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .links-section {
      margin-bottom: 2.5rem;
    }

    .links-grid {
      grid-template-columns: 1fr;
    }

    .section-title {
      font-size: 1.25rem;
    }

    .section-title i {
      font-size: 1.125rem;
    }

    .section-desc {
      font-size: 0.75rem;
    }

    .apply-section {
      margin-top: 3rem;
      padding-top: 2rem;
    }

    .apply-section-title {
      font-size: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .apply-card {
      min-height: auto;
    }

    .apply-card-header {
      padding: 1rem 1.125rem;
    }

    .apply-card-header h3 {
      font-size: 0.9375rem;
    }

    .apply-card-content {
      padding: 1.125rem;
    }

    .requirements-list {
      gap: 0.625rem;
    }

    .requirement-item {
      padding: 0.5rem 0.75rem;
    }

    .requirement-icon {
      width: 18px;
      height: 18px;
      font-size: 0.875rem;
    }

    .requirement-text strong {
      font-size: 0.75rem;
    }

    .requirement-text p {
      font-size: 0.6875rem;
    }

    .contact-button {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .contact-button i {
      font-size: 0.875rem;
    }

    .site-avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
    }

    .info-row {
      padding: 0.625rem 0.75rem;
    }

    .info-label {
      font-size: 0.625rem;
    }

    .info-value {
      font-size: 0.75rem;
    }

    .copy-btn {
      width: 28px;
      height: 28px;
      font-size: 0.875rem;
    }
  }
</style>
