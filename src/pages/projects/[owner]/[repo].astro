---
/**
 * Project Detail Page
 * Display GitHub README as blog post
 */
import { marked } from 'marked';
import ProjectDetailLayout from '../../../layouts/projects/ProjectDetailLayout.astro';
import ProjectDetailHeader from '../../../components/projects/ProjectDetailHeader.astro';
import ReadmeContent from '../../../components/projects/ReadmeContent.astro';
import { getGitHubRepo, getRepoReadme, getUserRepos } from '../../../utils/github';
import { githubUsername } from '../../../data/projects.config';

// Generate static paths
export async function getStaticPaths() {
  // Only fetch user's public repositories
  const userRepos = await getUserRepos(githubUsername);
  const projects = userRepos
    .filter(repo => !repo.isFork && !repo.isArchived)
    .map(repo => ({
      owner: repo.owner,
      name: repo.name,
    }));
  return projects.map(project => ({
    params: {
      owner: project.owner,
      repo: project.name
    }
  }));
}

const { owner, repo } = Astro.params;

if (!owner || !repo) {
  return Astro.redirect('/404');
}

// Get repository information
const repoInfo = await getGitHubRepo(owner, repo);
if (!repoInfo) {
  return Astro.redirect('/404');
}

// Get README content
const readmeContent = await getRepoReadme(owner, repo);
if (!readmeContent) {
  return Astro.redirect('/404');
}

// Remove YAML front matter (if exists)
// Match YAML blocks in the form --- ... ---
let processedContent = readmeContent;
const yamlFrontMatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n/;
const match = processedContent.match(yamlFrontMatterRegex);
if (match) {
  processedContent = processedContent.replace(yamlFrontMatterRegex, '');
}

// Convert Markdown to HTML
const htmlContent = await marked(processedContent);
---

<ProjectDetailLayout
  title={`${repoInfo.name} - Project Details`}
  description={repoInfo.description || `${repoInfo.name} Project Details`}
>
  <!-- Back button -->
  <button class="back-button" onclick="history.back()">
    <i class="i-carbon:arrow-left"></i>
    <span>Back to Projects</span>
  </button>

  <!-- Project header info -->
  <ProjectDetailHeader project={repoInfo} />

  <!-- README content -->
  <ReadmeContent htmlContent={htmlContent} />
</ProjectDetailLayout>

<style>
  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    background: var(--md-sys-color-surface-container-low);
    border: 1px solid var(--md-sys-color-outline-variant);
    border-radius: 999px;
    color: var(--md-sys-color-on-surface);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1.25rem;
  }

  .back-button:hover {
    background: var(--md-sys-color-surface-container);
    border-color: var(--md-sys-color-primary);
    color: var(--md-sys-color-primary);
    transform: translateX(-4px);
  }

  .back-button i {
    font-size: 1rem;
  }
</style>
