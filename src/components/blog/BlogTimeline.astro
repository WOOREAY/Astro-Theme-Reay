---
/**
 * BlogTimeline.astro
 * 博客时间线组件 - 显示按年份分组的博客文章列表
 */
import type { CollectionEntry } from 'astro:content';
import { getPostUrl } from '../../utils/blog';

interface Props {
  posts: CollectionEntry<'blog'>[];
}

const { posts } = Astro.props;

// 按年份分组
const postsByYear = posts.reduce((acc, post) => {
  const year = post.data.publishDate.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

// 获取所有年份并排序（最新的在前）
const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

// 获取月份和日期
function getMonthDay(date: Date) {
  return new Intl.DateTimeFormat('zh-CN', {
    month: '2-digit',
    day: '2-digit',
  }).format(date);
}

// 格式化完整日期
function formatFullDate(date: Date) {
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

// 计算阅读时间（假设每分钟阅读 300 字）
function calculateReadingTime(content: string): number {
  const wordsPerMinute = 300;
  const wordCount = content.length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, minutes); // 至少 1 分钟
}
---

<div class="timeline-container">
  {years.map((year) => {
    // 获取该年份的第一篇文章（最新的）
    const firstPost = postsByYear[year][0];
    const firstPostDate = firstPost.data.publishDate;
    const firstPostId = `post-${firstPostDate.getFullYear()}-${String(firstPostDate.getMonth() + 1).padStart(2, '0')}-${String(firstPostDate.getDate()).padStart(2, '0')}`;
    
    return (
    <div class="year-section mb-16">
      <!-- 年份标题 -->
      <div id={`year-${year}`} class="year-header sticky top-20 z-10 mb-6">
        <a 
          href={`#${firstPostId}`}
          class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-[var(--md-sys-color-primary-container)]/80 backdrop-blur-xl border border-[var(--md-sys-color-outline)]/10 shadow-md hover:shadow-lg hover:scale-105 transition-all duration-300"
        >
          <div class="w-1 h-1 rounded-full bg-[var(--md-sys-color-primary)] animate-pulse"></div>
          <h2 class="text-base font-600 text-[var(--md-sys-color-on-primary-container)]">
            {year}
          </h2>
          <span class="text-xs text-[var(--md-sys-color-on-primary-container)]/60">
            {postsByYear[year].length} 篇
          </span>
        </a>
      </div>

      <!-- 该年份的文章列表 -->
      <div class="posts-list relative">
        <!-- 时间线 -->
        <div class="timeline-line absolute left-[2.125rem] top-0 bottom-0 w-0.5 bg-gradient-to-b from-[var(--md-sys-color-primary)] via-[var(--md-sys-color-tertiary)] to-transparent"></div>

        {postsByYear[year].map((post) => {
          const postDate = post.data.publishDate;
          const dateId = `post-${postDate.getFullYear()}-${String(postDate.getMonth() + 1).padStart(2, '0')}-${String(postDate.getDate()).padStart(2, '0')}`;
          
          return (
          <article 
            id={dateId} 
            class="post-item relative pl-20 mb-6 group"
            data-year={postDate.getFullYear()}
            data-month={postDate.getMonth() + 1}
          >
            <!-- 时间点 -->
            <div class="timeline-dot absolute left-[1.625rem] top-4 w-2.5 h-2.5 rounded-full bg-[var(--md-sys-color-primary)] border-2 border-[var(--md-sys-color-surface)] shadow-lg group-hover:scale-150 group-hover:shadow-[0_0_20px_var(--md-sys-color-primary)] transition-all duration-300"></div>

            <!-- 日期标签 - 可点击跳转 -->
            <a 
              href={`#${dateId}`}
              class="date-label absolute left-[-0.5rem] top-3.5 text-xs font-600 text-[var(--md-sys-color-on-surface-variant)]/50 whitespace-nowrap hover:text-[var(--md-sys-color-primary)] hover:scale-110 transition-all duration-200 cursor-pointer"
              title="点击跳转到此日期"
            >
              {getMonthDay(post.data.publishDate)}
            </a>

            <!-- 文章卡片 -->
            <a 
              href={getPostUrl(post)}
              class="block p-4 rounded-xl bg-[var(--md-sys-color-surface-variant)]/30 hover:bg-[var(--md-sys-color-primary-container)]/20 border border-[var(--md-sys-color-outline)]/10 hover:border-[var(--md-sys-color-primary)]/30 hover:shadow-xl hover:-translate-y-1 transition-all duration-300"
            >
              <!-- 标题 -->
              <h3 class="text-lg font-700 text-[var(--md-sys-color-on-surface)] mb-2 group-hover:text-[var(--md-sys-color-primary)] transition-colors">
                {post.data.title}
              </h3>

              <!-- 描述 -->
              {post.data.description && (
                <p class="text-xs text-[var(--md-sys-color-on-surface-variant)] mb-3 line-clamp-2 leading-relaxed">
                  {post.data.description}
                </p>
              )}

              <!-- 元信息行 -->
              <div class="flex flex-wrap items-center gap-1.5 text-xs mb-2.5">
                <!-- 发布日期 -->
                <div class="flex items-center gap-1 text-[var(--md-sys-color-on-surface-variant)]/80">
                  <i class="i-carbon:calendar text-xs"></i>
                  <span>{formatFullDate(post.data.publishDate)}</span>
                </div>

                <!-- 分隔符 -->
                <span class="text-[var(--md-sys-color-outline)]">•</span>

                <!-- 阅读时间 -->
                <div class="flex items-center gap-1 text-[var(--md-sys-color-on-surface-variant)]/80">
                  <i class="i-carbon:time text-xs"></i>
                  <span>阅读约 {calculateReadingTime(post.body)} 分钟</span>
                </div>

                <!-- 精选标记 -->
                {post.data.featured && (
                  <>
                    <span class="text-[var(--md-sys-color-outline)]">•</span>
                    <div class="flex items-center gap-1 text-[var(--md-sys-color-primary)]">
                      <i class="i-carbon:star-filled text-xs"></i>
                      <span class="font-500">精选</span>
                    </div>
                  </>
                )}
              </div>

              <!-- 标签 -->
              <div class="flex flex-wrap items-center gap-1.5 text-xs">
                {post.data.tags.slice(0, 5).map((tag) => (
                  <span class="px-2 py-0.5 rounded-full bg-[var(--md-sys-color-surface-variant)]/50 text-[var(--md-sys-color-on-surface-variant)] font-400">
                    #{tag}
                  </span>
                ))}

                {post.data.tags.length > 5 && (
                  <span class="text-[var(--md-sys-color-on-surface-variant)]/50">
                    +{post.data.tags.length - 5}
                  </span>
                )}
              </div>
            </a>
          </article>
        )}
        )}
      </div>
    </div>
    );
  })}
</div>

<style>
  /* 时间线动画 */
  .timeline-line {
    opacity: 0;
    animation: fadeInLine 1s ease-out forwards;
  }

  @keyframes fadeInLine {
    from {
      opacity: 0;
      transform: scaleY(0);
      transform-origin: top;
    }
    to {
      opacity: 1;
      transform: scaleY(1);
    }
  }

  /* 文章项入场动画 */
  .post-item {
    opacity: 0;
    animation: fadeInUp 0.5s ease-out forwards;
  }

  .post-item:nth-child(1) { animation-delay: 0.1s; }
  .post-item:nth-child(2) { animation-delay: 0.2s; }
  .post-item:nth-child(3) { animation-delay: 0.3s; }
  .post-item:nth-child(4) { animation-delay: 0.4s; }
  .post-item:nth-child(5) { animation-delay: 0.5s; }
  .post-item:nth-child(n+6) { animation-delay: 0.6s; }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 年份标题阴影效果 */
  .year-header::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 120%;
    height: 120%;
    background: radial-gradient(
      circle,
      var(--md-sys-color-primary) 0%,
      transparent 70%
    );
    opacity: 0.1;
    z-index: -1;
    animation: pulse 3s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.1;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 0.05;
    }
  }

  /* 日期标签样式 */
  .date-label {
    z-index: 5; /* 确保在时间线高光之上 */
  }

  /* 平滑滚动 */
  html {
    scroll-behavior: smooth;
    scroll-padding-top: 100px; /* 为固定的 header 留出空间 */
  }

  /* 响应式调整 */
  @media (max-width: 640px) {
    .post-item {
      padding-left: 3rem;
    }

    .timeline-line {
      left: 1.125rem;
    }

    .timeline-dot {
      left: 0.625rem;
    }

    .date-label {
      left: -2.5rem !important;
      font-size: 0.7rem;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }
  }

  /* 文本截断 */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
